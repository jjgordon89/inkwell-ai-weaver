<!-- Generated by SpecStory -->

# Perform a deepscan of the codebase to see what sti (2025-06-25 11:01:28)

_**User**_

Perform a deepscan of the codebase to see what still needs to be worked on.

---

_**Assistant**_

Here’s a deep scan summary of what still needs to be worked on in your codebase, based on the provided project rules, coding standards, and the current state of `database.ts`:

---

## 1. Project Workflow & Navigation

- Ensure the app opens to the Projects page on startup.
- Confirm that the "Create New Project" button navigates to `/projects/new`.
- The `/projects/new` page must use a workflow (state machine) for project creation, including:
  - Template selection (with AI-powered option and live preview).
  - Project details editing.
  - Navigation (cancel, submit, back).
  - Database integration for persistence.
  - Extensibility for future steps (e.g., template selection, AI setup).

## 2. Database & Type Safety

- All database operations are in a Web Worker, but:
  - Ensure all types passed between main thread and worker are explicit and type-safe (no `any`/`unknown`).
  - Remove any unused `@ts-expect-error` or `eslint-disable` comments.
  - Validate and sanitize all user input before saving (already present in `database.ts`, but check all UI entry points).
  - Implement debounced and/or batched writes to `localStorage` for all autosave/AI scenarios (already present, but ensure it’s used everywhere needed).

## 3. AI Provider Management

- Ensure API keys are never hardcoded and are masked in all UI and API responses (already masked in `listAIProviders`).
- Implement a settings UI for managing AI providers (add/edit/delete, set active, mask API keys).
- Add fallback logic for AI provider failures (try secondary provider if main fails).

## 4. Template Library

- Allow users to edit and delete templates via the UI.
- Template selection UI should show richer previews and allow inline editing before use.
- Enable template re-use from both project creation and editing flows.

## 5. Error Handling & User Feedback

- Add granular loading/progress indicators for long-running operations (AI, DB, etc.).
- Implement robust error handling for slow/failed AI/database operations (timeouts, retries, user-friendly messages).
- Ensure all errors are surfaced in the UI, not just the console.

## 6. Settings & Customization

- Implement User Preferences UI (theme, autosave, etc.).
- Implement Project Settings UI as a side panel in the Writing Studio’s Editor view.

## 7. Testing & Validation

- Add comprehensive unit/integration tests for workflows, DB, and AI integration.
- Ensure strict type safety everywhere, especially in worker communication and AI result parsing.

## 8. Performance & Scalability

- Implement pagination or lazy loading for large project/template lists.
- Add database migration logic for future schema changes.

## 9. Security

- Add robust validation for all user inputs (not just JSON).
- Sanitize all user-generated content before rendering (prevent XSS/injection).

## 10. Documentation & Onboarding

- Add in-app help or onboarding for new users.
- Document all new features and APIs for maintainers.

---

### Observations from `database.ts`:

- JSDoc comments are present for public methods.
- Input sanitization and JSON validation are implemented for DB methods.
- Debounced save logic is present.
- API key masking is implemented.
- Type safety is generally good, but review all worker communication and ensure no `any`/`unknown` leaks.
- No unused `@ts-expect-error` or `eslint-disable` comments found in this file.

---

### Next Steps

- Review UI components and pages for compliance with the above rules (especially workflows, error handling, and settings).
- Ensure all user input points (forms, editors) use the `sanitizeString` utility.
- Audit all async operations for user feedback and error handling.
- Check for missing tests and documentation.

Let me know if you want a focused scan on a specific area or file!

---

_**User**_

Let

---

_**Assistant**_

It looks like your message was cut off. Could you please clarify what you’d like me to do next regarding the file contents or the previous deep scan? Let me know your specific request or question!

---

_**User**_

Let's work on the next steps:
- Review UI components and pages for compliance with the above rules (especially workflows, error handling, and settings).
- Ensure all user input points (forms, editors) use the `sanitizeString` utility.
- Audit all async operations for user feedback and error handling.
- Check for missing tests and documentation.



---

_**Assistant**_

Great plan! Here’s how we should proceed, step by step, to address your next actions:

---

## 1. Review UI Components and Pages for Compliance

**Goal:**  
- Ensure workflows, error handling, and settings UIs follow project rules and coding standards.

**Actions:**  
- Identify all relevant UI components/pages:  
  - Project creation/editing (workflow/state machine, template selection, AI integration)
  - AIProviderSettings
  - UserSettings, ProjectSettings
  - TemplateLibrary
  - Any forms/editors for user/project/template input

- For each, check:
  - Is a workflow/state machine used where required?
  - Are error/loading states surfaced to the user (not just console)?
  - Are settings editable and persisted via the database?
  - Is template selection rich, with previews and inline editing?

---

## 2. Ensure All User Input Points Use `sanitizeString`

**Goal:**  
- Prevent XSS/injection by sanitizing all user-facing string fields.

**Actions:**  
- Audit all forms and editors (project name, description, template fields, provider names, etc.).
- Check that `sanitizeString` is called before saving to the database or rendering user input.
- If not, update the relevant submit/handler logic to use `sanitizeString`.

---

## 3. Audit Async Operations for User Feedback and Error Handling

**Goal:**  
- Make sure all async actions (DB, AI, network) provide user feedback and robust error handling.

**Actions:**  
- For each async operation:
  - Is there a loading/progress indicator?
  - Are errors caught and shown to the user (not just logged)?
  - Are there timeouts/retries for slow/failing operations?
- Update components to add missing feedback/error handling as needed.

---

## 4. Check for Missing Tests and Documentation

**Goal:**  
- Ensure comprehensive test coverage and documentation for maintainability.

**Actions:**  
- Review test directory for:
  - Unit tests for workflows, DB, and AI integration.
  - Integration tests for user flows (project creation, template selection, provider management).
- Check for JSDoc comments on all public methods (especially in new/updated files).
- Add or update tests and documentation where missing.

---

### Next Step

Let’s start by listing all UI components/pages that handle user input or workflows. I’ll search for React components and pages in your `` and `` directories, then summarize which ones need review for the above points. Here’s a prioritized summary of the main UI components and pages that need to be reviewed and updated for compliance, input sanitization, async feedback, and documentation/testing:

---

## 1. Key Pages & Components to Review

### Project & Template Workflows
- `Projects.tsx` (Projects list, navigation)
- `NewProjectPage.tsx` (Project creation workflow)
- `TemplateLibrary.tsx` (Template selection, editing, preview)
- `ProjectSettings.tsx` (Project settings side panel)
- `Editor.tsx` / `EnhancedEditor.tsx` (Project editing, user input)
- `` (Story, WorldBuilding, etc. — user-generated content)

### AI Provider & Settings
- `AIProviderSettings.tsx` (AI provider management UI)
- `UserSettings.tsx` (User preferences/settings)

### Async Feedback & Error Handling
- `AsyncFeedback.tsx` (Feedback UI)
- All components/pages making async DB/AI calls

---

## 2. Next Steps

### A. Review and Update User Input Handling
- For each form/editor (project, template, provider, settings, world/story elements, etc.):
  - Ensure all string fields are sanitized with `sanitizeString` before saving or rendering.
  - Check for any direct use of user input in the UI or DB and update as needed.

### B. Audit Async Operations
- For each async operation (DB, AI, network):
  - Confirm there is a loading/progress indicator.
  - Ensure errors are caught and displayed to the user.
  - Add timeouts/retries where appropriate.

### C. Check for Missing Tests & Documentation
- Review the `test/` directory for coverage of:
  - Project/template workflows
  - AI provider management
  - Settings and user preferences
- Add or update JSDoc comments for all public methods in new/updated files.

---

## 3. Suggested Immediate Action

Would you like to:
- Start with a specific file (e.g., `NewProjectPage.tsx` for workflow and input sanitization)?
- Or do a quick scan for unsanitized user input in all forms/editors?
- Or focus on async feedback/error handling in a particular workflow?

Let me know your preferred focus, and I’ll proceed with a targeted review and actionable code changes.

---

_**User**_

Do a quick scan for unsanitized user input.

---

_**Assistant**_

Here’s a quick scan of `EditorView.tsx` for unsanitized user input:

### Findings

- The component receives and manipulates `activeDocument.title`, `activeDocument.status`, and `activeDocument.content`, which are likely user-generated.
- These values are passed directly to child components (`EditorViewHeader`, `EditorTextarea`, `EditorAIComponents`) and used in the UI.
- There is no evidence of `sanitizeString` being used on these fields before rendering or processing.

### Potential Issues

- If `activeDocument.title`, `status`, or `content` can contain unsanitized user input, this could lead to XSS or injection vulnerabilities, especially if any child component dangerously sets inner HTML or renders raw HTML.
- The `selectedText` and `newText` in AI suggestion logic are also user-controlled and should be sanitized before being saved or rendered.

### Recommendations

- Sanitize `activeDocument.title`, `status`, and `content` with `sanitizeString` before rendering or passing to child components.
- Ensure any text inserted or replaced in the document (e.g., via AI suggestions) is sanitized before saving or rendering.
- Review child components (`EditorViewHeader`, `EditorTextarea`, `EditorAIComponents`) to ensure they do not render unsanitized input as HTML.

Would you like me to update this file to apply `sanitizeString` to all user-facing fields, or would you like to review a specific child component next?

---

